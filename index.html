<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tahta Kilit (QR Onay)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { margin:0; font-family:system-ui, Arial; background:#0b0f19; color:#fff; }
    .center { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:22px; }
    .card { width:min(720px, 95vw); background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
            border-radius:18px; padding:22px; box-shadow:0 18px 40px rgba(0,0,0,0.35); text-align:center; }
    #qrcode { background:#fff; padding:14px; border-radius:14px; display:inline-block; }
    .muted { color:rgba(255,255,255,0.72); font-size:13px; word-break:break-word; }
    .btn { padding:16px 26px; font-size:18px; border:0; border-radius:999px; cursor:pointer; background:#0d6efd; color:#fff; }
    .btn:active { transform:scale(0.98); }
    .btn.green { background:#28a745; }
    .btn.gray { background:#6c757d; }
    .hidden { display:none; }
    .ok { color:#7CFFB2; font-weight:700; }
    .bad { color:#ffb3b3; font-weight:700; }
  </style>
</head>

<body>

<!-- TAHTA KÄ°LÄ°T EKRANI -->
<div id="lockScreen" class="center">
  <div class="card">
    <h1>ğŸ”’ Tahta Kilitli</h1>
    <p>Telefonla QR okut â†’ <b>ONAYLA</b> â†’ Tahta aÃ§Ä±lÄ±r.</p>

    <div id="qrcode"></div>

    <p id="status" class="muted">ID oluÅŸturuluyorâ€¦</p>
    <p id="debug" class="muted"></p>

    <button class="btn gray" id="newQrBtn">Yeni QR</button>
  </div>
</div>

<!-- TAHTA AÃ‡IK EKRAN (istersen bunu hiÃ§ gÃ¶stermeden direkt yÃ¶nlendirebiliriz) -->
<div id="openScreen" class="center hidden">
  <div class="card">
    <h1>âœ… Tahta AÃ§Ä±ldÄ±</h1>
    <p class="muted">YÃ¶nlendiriliyorâ€¦</p>
    <button class="btn gray" id="lockBtn">Tekrar Kilitle</button>
  </div>
</div>

<!-- TELEFON ONAY -->
<div id="phoneScreen" class="center hidden">
  <div class="card">
    <h1>ğŸ“± Telefon OnayÄ±</h1>
    <p>TahtayÄ± aÃ§mak iÃ§in <b>ONAYLA</b>.</p>

    <button class="btn green" id="approveBtn">ONAYLA</button>
    <button class="btn gray" id="cancelBtn">Ä°ptal</button>

    <p id="phoneStatus" class="muted">BaÄŸlanÄ±yorâ€¦</p>
    <p id="phoneDebug" class="muted"></p>
  </div>
</div>

<script>
(() => {
  // âœ… Kilit aÃ§Ä±lÄ±nca gidilecek sayfa:
  // Buraya "normal masaÃ¼stÃ¼" yerine kullanmak istediÄŸin web sayfasÄ±nÄ± yaz.
  const AFTER_UNLOCK_URL = "https://www.google.com"; // <-- BUNU DEÄÄ°ÅTÄ°R

  const params = new URLSearchParams(location.search);
  const remoteId = params.get("id"); // varsa telefon modu

  const lockScreen  = document.getElementById("lockScreen");
  const openScreen  = document.getElementById("openScreen");
  const phoneScreen = document.getElementById("phoneScreen");

  const statusEl = document.getElementById("status");
  const debugEl  = document.getElementById("debug");

  const newQrBtn = document.getElementById("newQrBtn");
  const lockBtn  = document.getElementById("lockBtn");

  const approveBtn = document.getElementById("approveBtn");
  const cancelBtn  = document.getElementById("cancelBtn");
  const phoneStatus = document.getElementById("phoneStatus");
  const phoneDebug  = document.getElementById("phoneDebug");

  let conn = null;

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  function baseUrl() {
    const u = new URL(location.href);
    u.search = "";
    u.hash = "";
    u.pathname = u.pathname.replace(/index\.html$/i, "");
    return u.toString();
  }

  // PeerJS Cloud
  const peer = new Peer({
    host: "0.peerjs.com",
    port: 443,
    secure: true,
    path: "/"
  });

  // -------- TELEFON MODU --------
  if (remoteId) {
    hide(lockScreen); hide(openScreen); show(phoneScreen);

    peer.on("open", (myId) => {
      phoneDebug.textContent = "Telefon Peer ID: " + myId;

      conn = peer.connect(remoteId, { reliable: true });

      conn.on("open", () => {
        phoneStatus.innerHTML = "<span class='ok'>Tahtaya baÄŸlandÄ± âœ…</span>";
      });

      conn.on("close", () => {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span>";
      });

      conn.on("error", (e) => {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± hatasÄ± âŒ</span>";
        phoneDebug.textContent = "Detay: " + (e?.message || e);
      });
    });

    approveBtn.addEventListener("click", () => {
      if (conn && conn.open) {
        conn.send("UNLOCK");
        phoneStatus.innerHTML = "<span class='ok'>Onay gÃ¶nderildi âœ…</span>";
      } else {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± yok âŒ</span>";
      }
    });

    cancelBtn.addEventListener("click", () => {
      phoneStatus.textContent = "Ä°ptal edildi.";
    });

    peer.on("error", (err) => {
      phoneStatus.innerHTML = "<span class='bad'>PeerJS hatasÄ± âŒ</span>";
      phoneDebug.textContent = (err?.type || "") + " - " + (err?.message || err);
    });

    return;
  }

  // -------- TAHTA MODU --------
  function makeQR(myId) {
    const phoneUrl = baseUrl() + "?id=" + encodeURIComponent(myId);
    const qrEl = document.getElementById("qrcode");
    qrEl.innerHTML = "";
    new QRCode(qrEl, { text: phoneUrl, width: 256, height: 256 });
  }

  peer.on("open", (myId) => {
    statusEl.textContent = "Telefonla QR okutun.";
    debugEl.textContent  = "Tahta Peer ID: " + myId;
    makeQR(myId);

    newQrBtn.onclick = () => location.reload(); // en basit yeni ID
  });

  peer.on("connection", (c) => {
    conn = c;
    statusEl.innerHTML = "<span class='ok'>Telefon baÄŸlandÄ± âœ…</span> Telefonda ONAYLA bekleniyorâ€¦";

    conn.on("data", (msg) => {
      if (msg === "UNLOCK") {
        // âœ… WEB KÄ°LÄ°DÄ° KALKTI
        hide(lockScreen);
        show(openScreen);

        // 0.5 sn sonra hedef sayfaya git (senin â€œnormal kullanÄ±mâ€ dediÄŸin yer)
        setTimeout(() => {
          location.href = AFTER_UNLOCK_URL;
        }, 500);
      }
      if (msg === "LOCK") {
        show(lockScreen); hide(openScreen);
      }
    });

    conn.on("close", () => {
      show(lockScreen); hide(openScreen);
      statusEl.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span> Tekrar QR okutun.";
    });
  });

  lockBtn.addEventListener("click", () => {
    show(lockScreen); hide(openScreen);
    if (conn && conn.open) conn.send("LOCK");
  });

  peer.on("error", (err) => {
    statusEl.innerHTML = "<span class='bad'>PeerJSâ€™e baÄŸlanamadÄ± âŒ (aÄŸ engeli olabilir)</span>";
    debugEl.textContent = (err?.type || "") + " - " + (err?.message || err);
  });
})();
</script>
</body>
</html>
