<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tahta Kilit (QR + PIN)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:#0b0f19;color:#fff}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px}
    .card{width:min(980px,96vw);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      border-radius:18px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
    .row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center}
    .col{flex:1 1 360px}
    h1,h2{margin:6px 0 10px}
    .muted{color:rgba(255,255,255,.75);font-size:13px;word-break:break-word}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:rgba(255,255,255,.12)}
    .ok{color:#7CFFB2;font-weight:700}
    .bad{color:#ffb3b3;font-weight:700}
    #qrcode{background:#fff;padding:12px;border-radius:14px;display:inline-block}
    .hidden{display:none!important}
    .btn{padding:14px 18px;font-size:16px;border:0;border-radius:999px;cursor:pointer;background:#0d6efd;color:#fff}
    .btn:active{transform:scale(.98)}
    .btn.green{background:#28a745}
    .btn.gray{background:#6c757d}
    .btn.red{background:#dc3545}

    /* PIN */
    .pinBox{text-align:center}
    .pinDots{display:flex;justify-content:center;gap:10px;margin:12px 0 10px}
    .dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,.25)}
    .dot.filled{background:#fff}
    .pad{display:grid;grid-template-columns:repeat(3,90px);gap:10px;justify-content:center;margin-top:10px}
    .key{height:64px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);color:#fff;font-size:22px;cursor:pointer}
    .key:active{transform:scale(.98)}
    .line{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    input{padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);color:#fff;outline:none;width:min(260px,80vw)}

    /* AÃ§Ä±ldÄ± ekranÄ± */
    .big{font-size:22px}
    .kbd{display:inline-block;padding:6px 10px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:rgba(0,0,0,.25)}
  </style>
</head>

<body>

<!-- TAHTA KÄ°LÄ°T -->
<div id="lockScreen" class="center">
  <div class="card">
    <h1>ğŸ”’ Tahta Kilitli</h1>
    <p class="muted">Ä°nternet varsa QR ile onaylayÄ±n. Ä°nternet yoksa PIN ile aÃ§Ä±n.</p>

    <div class="row">
      <!-- QR -->
      <div class="col">
        <h2>QR ile Onay</h2>
        <div id="qrcode"></div>
        <p id="qrStatus" class="muted">QR hazÄ±rlanÄ±yorâ€¦</p>
        <p id="peerDebug" class="muted"></p>
        <span class="badge" id="netBadge">Durum: <span class="bad">Kontrol ediliyorâ€¦</span></span>
      </div>

      <!-- PIN -->
      <div class="col pinBox">
        <h2>PIN ile AÃ§ (Offline)</h2>
        <p class="muted">VarsayÄ±lan PIN: <b>1234</b> (ilk kurulum). Sonra deÄŸiÅŸtirebilirsin.</p>

        <div class="pinDots" id="dots"></div>
        <div class="muted" id="pinMsg"></div>

        <div class="pad" id="pad"></div>

        <div class="line" style="margin-top:14px;">
          <button class="btn gray" id="clearBtn">Temizle</button>
          <button class="btn red" id="backBtn">Sil</button>
          <button class="btn green" id="enterBtn">GÄ°R</button>
        </div>

        <hr style="margin:16px 0;border-color:rgba(255,255,255,.12)">

        <h2>PIN DeÄŸiÅŸtir</h2>
        <p class="muted">Mevcut PIN + Yeni PIN gir.</p>
        <div class="line">
          <input id="oldPin" placeholder="Mevcut PIN" inputmode="numeric" maxlength="12">
          <input id="newPin" placeholder="Yeni PIN (en az 4)" inputmode="numeric" maxlength="12">
        </div>
        <div class="line">
          <button class="btn" id="changePinBtn">PIN DEÄÄ°ÅTÄ°R</button>
        </div>
        <div class="muted" id="changeMsg"></div>
      </div>
    </div>
  </div>
</div>

<!-- TAHTA AÃ‡IK -->
<div id="openScreen" class="center hidden">
  <div class="card" style="text-align:center;">
    <h1>âœ… Tahta AÃ§Ä±ldÄ±</h1>
    <p class="big">MasaÃ¼stÃ¼ne dÃ¶nmek iÃ§in <span class="kbd">ALT</span> + <span class="kbd">F4</span></p>
    <p class="muted">
      Not: TarayÄ±cÄ±, gÃ¼venlik nedeniyle kendi kendini her zaman kapatamaz.
      Kiosk/App modda ise otomatik kapanma daha olasÄ±dÄ±r.
    </p>
    <div class="line" style="justify-content:center;">
      <button class="btn gray" id="tryCloseBtn">TarayÄ±cÄ±yÄ± KapatmayÄ± Dene</button>
      <button class="btn gray" id="lockBtn">Tekrar Kilitle</button>
    </div>
    <p class="muted" id="openMsg"></p>
  </div>
</div>

<!-- TELEFON ONAY -->
<div id="phoneScreen" class="center hidden">
  <div class="card" style="text-align:center;">
    <h1>ğŸ“± Telefon OnayÄ±</h1>
    <p class="muted">TahtayÄ± aÃ§mak iÃ§in ONAYLA.</p>
    <div class="line" style="justify-content:center;">
      <button class="btn green" id="approveBtn">ONAYLA</button>
      <button class="btn gray" id="cancelBtn">Ä°ptal</button>
    </div>
    <p id="phoneStatus" class="muted">BaÄŸlanÄ±yorâ€¦</p>
    <p id="phoneDebug" class="muted"></p>
  </div>
</div>

<script>
(() => {
  // ========= AYARLAR =========
  // Kilit aÃ§Ä±lÄ±nca otomatik "masaÃ¼stÃ¼" diye bir ÅŸey web ile aÃ§Ä±lamaz.
  // Ama istersen bir hedef siteye yÃ¶nlendirebilirsin:
  const AFTER_UNLOCK_URL = ""; // Ã¶rn: "https://eba.gov.tr"  (boÅŸ bÄ±rakÄ±nca yÃ¶nlendirme yok)

  const DEFAULT_PIN = "1234";
  const PIN_KEY = "TAHTA_PIN_V1";

  // ========= DOM =========
  const params = new URLSearchParams(location.search);
  const remoteId = params.get("id"); // telefon modu

  const lockScreen = document.getElementById("lockScreen");
  const openScreen = document.getElementById("openScreen");
  const phoneScreen = document.getElementById("phoneScreen");

  const qrStatus = document.getElementById("qrStatus");
  const peerDebug = document.getElementById("peerDebug");
  const netBadge = document.getElementById("netBadge");

  const dotsEl = document.getElementById("dots");
  const padEl = document.getElementById("pad");
  const pinMsg = document.getElementById("pinMsg");

  const clearBtn = document.getElementById("clearBtn");
  const backBtn = document.getElementById("backBtn");
  const enterBtn = document.getElementById("enterBtn");

  const oldPinEl = document.getElementById("oldPin");
  const newPinEl = document.getElementById("newPin");
  const changePinBtn = document.getElementById("changePinBtn");
  const changeMsg = document.getElementById("changeMsg");

  const lockBtn = document.getElementById("lockBtn");
  const tryCloseBtn = document.getElementById("tryCloseBtn");
  const openMsg = document.getElementById("openMsg");

  const approveBtn = document.getElementById("approveBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const phoneStatus = document.getElementById("phoneStatus");
  const phoneDebug = document.getElementById("phoneDebug");

  let conn = null;
  let currentPinInput = "";

  const show = el => el.classList.remove("hidden");
  const hide = el => el.classList.add("hidden");

  function showLock(){ show(lockScreen); hide(openScreen); hide(phoneScreen); }
  function showOpen(){ hide(lockScreen); show(openScreen); hide(phoneScreen); }

  // ========= PIN =========
  function getSavedPin() {
    const p = localStorage.getItem(PIN_KEY);
    return (p && p.length >= 4) ? p : DEFAULT_PIN;
  }
  function setSavedPin(p) { localStorage.setItem(PIN_KEY, p); }

  function renderDots() {
    dotsEl.innerHTML = "";
    const len = Math.min(currentPinInput.length, 4);
    for (let i = 0; i < 4; i++) {
      const dot = document.createElement("div");
      dot.className = "dot" + (i < len ? " filled" : "");
      dotsEl.appendChild(dot);
    }
  }

  function setPinMessage(text, ok=false) {
    pinMsg.innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="bad">${text}</span>`;
    setTimeout(() => { pinMsg.textContent = ""; }, 1600);
  }

  function buildPad() {
    padEl.innerHTML = "";
    const nums = ["1","2","3","4","5","6","7","8","9","0"];
    nums.forEach(n => {
      const b = document.createElement("button");
      b.className = "key";
      b.textContent = n;
      b.addEventListener("click", () => {
        if (currentPinInput.length >= 4) return;
        currentPinInput += n;
        renderDots();
      });
      padEl.appendChild(b);
    });
  }

  function unlockBoard(source) {
    showOpen();
    openMsg.textContent = "AÃ§Ä±ldÄ± (" + source + ").";

    // Ä°stersen aÃ§Ä±lÄ±nca bir web sayfasÄ±na yÃ¶nlen (masaÃ¼stÃ¼ yerine)
    if (AFTER_UNLOCK_URL) {
      setTimeout(() => location.href = AFTER_UNLOCK_URL, 600);
    }

    // TarayÄ±cÄ±yÄ± kapatmayÄ± DENE (Ã§oÄŸu zaman engellenir)
    setTimeout(() => { tryClose(); }, 900);
  }

  function tryClose() {
    try {
      // BazÄ± durumlarda (app/kiosk/JS ile aÃ§Ä±lan pencere) iÅŸe yarar
      window.open("", "_self");
      window.close();
    } catch (e) {}
  }

  function tryUnlockByPin() {
    const realPin = getSavedPin();
    if (currentPinInput === realPin) {
      setPinMessage("PIN doÄŸru âœ…", true);
      unlockBoard("PIN");
    } else {
      setPinMessage("PIN yanlÄ±ÅŸ âŒ");
      currentPinInput = "";
      renderDots();
    }
  }

  // PIN butonlarÄ±
  buildPad();
  renderDots();

  clearBtn.addEventListener("click", () => { currentPinInput=""; renderDots(); });
  backBtn.addEventListener("click", () => { currentPinInput=currentPinInput.slice(0,-1); renderDots(); });
  enterBtn.addEventListener("click", tryUnlockByPin);

  // PIN deÄŸiÅŸtir
  const onlyDigits = s => (s || "").replace(/\D/g, "");
  changePinBtn.addEventListener("click", () => {
    const oldP = onlyDigits(oldPinEl.value);
    const newP = onlyDigits(newPinEl.value);
    const realP = getSavedPin();

    if (!oldP || !newP) return changeMsg.innerHTML = "<span class='bad'>Ä°ki alan da dolu olmalÄ±.</span>";
    if (oldP !== realP) return changeMsg.innerHTML = "<span class='bad'>Mevcut PIN yanlÄ±ÅŸ âŒ</span>";
    if (newP.length < 4) return changeMsg.innerHTML = "<span class='bad'>Yeni PIN 4 haneli olmalÄ±.</span>";

    setSavedPin(newP);
    oldPinEl.value = ""; newPinEl.value = "";
    changeMsg.innerHTML = "<span class='ok'>PIN deÄŸiÅŸtirildi âœ…</span>";
    setTimeout(() => changeMsg.textContent = "", 1600);
  });

  // ========= Ä°nternet gÃ¶stergesi =========
  function updateNetBadge() {
    netBadge.innerHTML = navigator.onLine
      ? 'Durum: <span class="ok">Ä°nternet var</span>'
      : 'Durum: <span class="bad">Ä°nternet yok</span>';
  }
  window.addEventListener("online", updateNetBadge);
  window.addEventListener("offline", updateNetBadge);
  updateNetBadge();

  // ========= QR base =========
  function baseUrl() {
    const u = new URL(location.href);
    u.search = ""; u.hash = "";
    u.pathname = u.pathname.replace(/index\.html$/i, "");
    return u.toString();
  }

  // ========= PeerJS =========
  const peer = new Peer({ host:"0.peerjs.com", port:443, secure:true, path:"/" });

  // ---- TELEFON ----
  if (remoteId) {
    hide(lockScreen); hide(openScreen); show(phoneScreen);

    peer.on("open", (myId) => {
      phoneDebug.textContent = "Telefon Peer ID: " + myId;
      conn = peer.connect(remoteId, { reliable:true });

      conn.on("open", () => phoneStatus.innerHTML = "<span class='ok'>Tahtaya baÄŸlandÄ± âœ…</span>");
      conn.on("close", () => phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span>");
      conn.on("error", (e) => {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± hatasÄ± âŒ</span>";
        phoneDebug.textContent = "Detay: " + (e?.message || e);
      });
    });

    approveBtn.addEventListener("click", () => {
      if (conn && conn.open) {
        conn.send("UNLOCK");
        phoneStatus.innerHTML = "<span class='ok'>Onay gÃ¶nderildi âœ…</span>";
      } else {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± yok âŒ</span>";
      }
    });

    cancelBtn.addEventListener("click", () => phoneStatus.textContent = "Ä°ptal edildi.");

    peer.on("error", (err) => {
      phoneStatus.innerHTML = "<span class='bad'>PeerJS hatasÄ± âŒ</span>";
      phoneDebug.textContent = (err?.type || "") + " - " + (err?.message || err);
    });

    return;
  }

  // ---- TAHTA ----
  function makeQR(myId) {
    const phoneUrl = baseUrl() + "?id=" + encodeURIComponent(myId);
    const qrEl = document.getElementById("qrcode");
    qrEl.innerHTML = "";
    new QRCode(qrEl, { text: phoneUrl, width: 256, height: 256 });
  }

  peer.on("open", (myId) => {
    qrStatus.textContent = "Telefonla QR okutun (internet varsa).";
    peerDebug.textContent = "Tahta Peer ID: " + myId;
    makeQR(myId);
  });

  peer.on("connection", (c) => {
    conn = c;
    qrStatus.innerHTML = "<span class='ok'>Telefon baÄŸlandÄ± âœ…</span> Telefonda ONAYLA bekleniyorâ€¦";
    conn.on("data", (msg) => { if (msg === "UNLOCK") unlockBoard("QR Onay"); });
    conn.on("close", () => qrStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span> PIN ile aÃ§abilirsiniz.");
  });

  peer.on("error", (err) => {
    qrStatus.innerHTML = "<span class='bad'>QR baÄŸlantÄ±sÄ± yok âŒ</span> PIN ile aÃ§abilirsiniz.";
    peerDebug.textContent = (err?.type || "") + " - " + (err?.message || err);
  });

  // AÃ§Ä±k ekranda butonlar
  lockBtn.addEventListener("click", () => { currentPinInput=""; renderDots(); showLock(); });
  tryCloseBtn.addEventListener("click", tryClose);

})();
</script>
</body>
</html>
