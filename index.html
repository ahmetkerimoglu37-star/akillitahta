<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tahta Kilit (QR + Offline PIN)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { margin:0; font-family:system-ui, Arial; background:#0b0f19; color:#fff; }
    .center { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:22px; }
    .card { width:min(980px, 96vw); background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
            border-radius:18px; padding:22px; box-shadow:0 18px 40px rgba(0,0,0,0.35); text-align:center; }
    #qrcode { background:#fff; padding:14px; border-radius:14px; display:inline-block; }
    .muted { color:rgba(255,255,255,0.72); font-size:13px; word-break:break-word; }
    .btn { padding:14px 18px; font-size:16px; border:0; border-radius:999px; cursor:pointer; background:#0d6efd; color:#fff; }
    .btn:active { transform:scale(0.98); }
    .btn.green { background:#28a745; }
    .btn.gray { background:#6c757d; }
    .btn.red { background:#dc3545; }
    .hidden { display:none; }
    .ok { color:#7CFFB2; font-weight:700; }
    .bad { color:#ffb3b3; font-weight:700; }

    .row { display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start; justify-content:center; margin-top:16px; }
    .col { flex: 1 1 320px; }

    /* PIN */
    .dots { display:flex; justify-content:center; gap:10px; margin:12px 0 8px; }
    .dot { width:14px; height:14px; border-radius:50%; background:rgba(255,255,255,0.25); }
    .dot.filled { background:#fff; }
    .pad { display:grid; grid-template-columns:repeat(3, 86px); gap:10px; justify-content:center; margin:10px 0; }
    .key { height:60px; border-radius:14px; border:1px solid rgba(255,255,255,0.14);
           background:rgba(255,255,255,0.10); color:#fff; font-size:22px; cursor:pointer; }
    .key:active { transform:scale(0.98); }
    .line { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    input { padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.18);
            background:rgba(0,0,0,0.20); color:#fff; outline:none; width:min(260px, 80vw); }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; background:rgba(255,255,255,0.12); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>

<body>

<!-- TAHTA KÄ°LÄ°T -->
<div id="lockScreen" class="center">
  <div class="card">
    <h1>ğŸ”’ Tahta Kilitli</h1>
    <p class="muted">Ä°nternet varsa QR ile telefon onayÄ±. Ä°nternet yoksa PIN ile aÃ§.</p>

    <div class="row">
      <!-- QR -->
      <div class="col">
        <h2>QR ile Onay</h2>
        <div id="qrcode"></div>
        <p id="status" class="muted">ID oluÅŸturuluyorâ€¦</p>
        <p id="debug" class="muted mono"></p>
        <span class="badge" id="netBadge">Durum: ...</span>
        <div class="line">
          <button class="btn gray" id="newQrBtn">Yeni QR</button>
          <button class="btn gray" id="testBtn">TEST: Hedefe Git</button>
        </div>
      </div>

      <!-- PIN -->
      <div class="col">
        <h2>Offline PIN</h2>
        <p class="muted">VarsayÄ±lan PIN: <b>1234</b></p>

        <div class="dots" id="dots"></div>
        <div class="muted" id="pinMsg"></div>

        <div class="pad" id="pad"></div>

        <div class="line">
          <button class="btn gray" id="clearBtn">Temizle</button>
          <button class="btn red" id="backBtn">Sil</button>
          <button class="btn green" id="enterBtn">GÄ°R</button>
        </div>

        <hr style="margin:16px 0; border-color: rgba(255,255,255,0.12);">

        <h3>PIN DeÄŸiÅŸtir</h3>
        <div class="line">
          <input id="oldPin" placeholder="Mevcut PIN" inputmode="numeric" maxlength="12">
          <input id="newPin" placeholder="Yeni PIN (en az 4)" inputmode="numeric" maxlength="12">
        </div>
        <div class="line">
          <button class="btn" id="changePinBtn">PIN DEÄÄ°ÅTÄ°R</button>
        </div>
        <div class="muted" id="changeMsg"></div>
      </div>
    </div>
  </div>
</div>

<!-- TELEFON -->
<div id="phoneScreen" class="center hidden">
  <div class="card">
    <h1>ğŸ“± Telefon OnayÄ±</h1>
    <p class="muted">TahtayÄ± aÃ§mak iÃ§in ONAYLA.</p>
    <div class="line">
      <button class="btn green" id="approveBtn">ONAYLA</button>
      <button class="btn gray" id="cancelBtn">Ä°ptal</button>
    </div>
    <p id="phoneStatus" class="muted">BaÄŸlanÄ±yorâ€¦</p>
    <p id="phoneDebug" class="muted mono"></p>
  </div>
</div>

<script>
(() => {
  // âœ… Kilit aÃ§Ä±lÄ±nca gidilecek hedef (bunu deÄŸiÅŸtir)
  const AFTER_UNLOCK_URL = "https://www.google.com";

  // âœ… PIN
  const DEFAULT_PIN = "1234";
  const PIN_KEY = "TAHTA_PIN_V1";

  // ---- DOM ----
  const params = new URLSearchParams(location.search);
  const remoteId = params.get("id");

  const lockScreen = document.getElementById("lockScreen");
  const phoneScreen = document.getElementById("phoneScreen");

  const statusEl = document.getElementById("status");
  const debugEl = document.getElementById("debug");
  const netBadge = document.getElementById("netBadge");
  const newQrBtn = document.getElementById("newQrBtn");
  const testBtn = document.getElementById("testBtn");

  const approveBtn = document.getElementById("approveBtn");
  const cancelBtn  = document.getElementById("cancelBtn");
  const phoneStatus = document.getElementById("phoneStatus");
  const phoneDebug  = document.getElementById("phoneDebug");

  const dotsEl = document.getElementById("dots");
  const padEl = document.getElementById("pad");
  const pinMsg = document.getElementById("pinMsg");
  const clearBtn = document.getElementById("clearBtn");
  const backBtn = document.getElementById("backBtn");
  const enterBtn = document.getElementById("enterBtn");

  const oldPinEl = document.getElementById("oldPin");
  const newPinEl = document.getElementById("newPin");
  const changePinBtn = document.getElementById("changePinBtn");
  const changeMsg = document.getElementById("changeMsg");

  let conn = null;
  let pinInput = "";

  const show = el => el.classList.remove("hidden");
  const hide = el => el.classList.add("hidden");

  function baseUrl() {
    const u = new URL(location.href);
    u.search = "";
    u.hash = "";
    u.pathname = u.pathname.replace(/index\.html$/i, "");
    return u.toString();
  }

  function updateNetBadge() {
    netBadge.innerHTML = navigator.onLine
      ? 'Durum: <span class="ok">Ä°nternet var</span>'
      : 'Durum: <span class="bad">Ä°nternet yok</span> (PIN kullan)';
  }
  window.addEventListener("online", updateNetBadge);
  window.addEventListener("offline", updateNetBadge);
  updateNetBadge();

  // âœ… SAÄLAM YÃ–NLENDÄ°RME
  function goTarget(reason) {
    statusEl.innerHTML = "<span class='ok'>AÃ§Ä±ldÄ± âœ…</span> (" + reason + ") â€” yÃ¶nleniyorâ€¦";
    debugEl.textContent = "Hedef: " + AFTER_UNLOCK_URL;

    // 0) kÃ¼Ã§Ã¼k gecikme (bazÄ± cihazlarda daha stabil)
    setTimeout(() => {
      try { location.replace(AFTER_UNLOCK_URL); return; } catch (e) {}
      try { location.href = AFTER_UNLOCK_URL; return; } catch (e) {}
      try { window.open(AFTER_UNLOCK_URL, "_self"); return; } catch (e) {}

      // Son Ã§are: link gÃ¶ster
      statusEl.innerHTML = "<span class='bad'>YÃ¶nlendirme engellendi</span> â€” linke tÄ±klayÄ±n:";
      debugEl.innerHTML = "<a style='color:#7CFFB2' href='" + AFTER_UNLOCK_URL + "'>" + AFTER_UNLOCK_URL + "</a>";
    }, 200);
  }

  // ---- PIN ----
  function getPin() {
    const p = localStorage.getItem(PIN_KEY);
    return (p && p.length >= 4) ? p : DEFAULT_PIN;
  }
  function setPin(p) { localStorage.setItem(PIN_KEY, p); }
  function renderDots() {
    dotsEl.innerHTML = "";
    for (let i = 0; i < 4; i++) {
      const d = document.createElement("div");
      d.className = "dot" + (i < pinInput.length ? " filled" : "");
      dotsEl.appendChild(d);
    }
  }
  function msg(el, text, ok=false) {
    el.innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="bad">${text}</span>`;
    setTimeout(() => { el.textContent = ""; }, 1400);
  }
  function buildPad() {
    const nums = ["1","2","3","4","5","6","7","8","9","0"];
    padEl.innerHTML = "";
    nums.forEach(n => {
      const b = document.createElement("button");
      b.className = "key";
      b.textContent = n;
      b.onclick = () => {
        if (pinInput.length >= 4) return;
        pinInput += n;
        renderDots();
      };
      padEl.appendChild(b);
    });
  }
  function unlockByPin() {
    if (pinInput === getPin()) {
      msg(pinMsg, "PIN doÄŸru âœ…", true);
      goTarget("PIN");
    } else {
      msg(pinMsg, "PIN yanlÄ±ÅŸ âŒ");
      pinInput = "";
      renderDots();
    }
  }

  buildPad();
  renderDots();
  clearBtn.onclick = () => { pinInput=""; renderDots(); };
  backBtn.onclick = () => { pinInput = pinInput.slice(0, -1); renderDots(); };
  enterBtn.onclick = unlockByPin;
  window.addEventListener("keydown", (e) => { if (e.key === "Enter") unlockByPin(); });

  changePinBtn.onclick = () => {
    const oldP = (oldPinEl.value || "").replace(/\D/g,"");
    const newP = (newPinEl.value || "").replace(/\D/g,"");
    if (!oldP || !newP) return msg(changeMsg, "Ä°ki alan dolu olmalÄ±.");
    if (oldP !== getPin()) return msg(changeMsg, "Mevcut PIN yanlÄ±ÅŸ âŒ");
    if (newP.length < 4) return msg(changeMsg, "Yeni PIN en az 4 hane.");
    setPin(newP);
    oldPinEl.value = ""; newPinEl.value = "";
    msg(changeMsg, "PIN deÄŸiÅŸti âœ…", true);
  };

  // TEST butonu: yÃ¶nlendirme cihazda Ã§alÄ±ÅŸÄ±yor mu?
  testBtn.onclick = () => goTarget("TEST");

  // ---- PeerJS ----
  const peer = new Peer({ host:"0.peerjs.com", port:443, secure:true, path:"/" });

  // TELEFON MODU
  if (remoteId) {
    hide(lockScreen); show(phoneScreen);

    peer.on("open", (myId) => {
      phoneDebug.textContent = "Telefon Peer ID: " + myId;
      conn = peer.connect(remoteId, { reliable:true });

      conn.on("open", () => phoneStatus.innerHTML = "<span class='ok'>Tahtaya baÄŸlandÄ± âœ…</span>");
      conn.on("close", () => phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span>");
      conn.on("error", (e) => {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± hatasÄ± âŒ</span>";
        phoneDebug.textContent = "Detay: " + (e?.message || e);
      });
    });

    approveBtn.onclick = () => {
      if (conn && conn.open) {
        conn.send("UNLOCK");
        phoneStatus.innerHTML = "<span class='ok'>Onay gÃ¶nderildi âœ…</span>";
      } else {
        phoneStatus.innerHTML = "<span class='bad'>BaÄŸlantÄ± yok âŒ</span>";
      }
    };

    cancelBtn.onclick = () => phoneStatus.textContent = "Ä°ptal edildi.";

    peer.on("error", (err) => {
      phoneStatus.innerHTML = "<span class='bad'>PeerJS hatasÄ± âŒ</span>";
      phoneDebug.textContent = (err?.type || "") + " - " + (err?.message || err);
    });

    return;
  }

  // TAHTA MODU
  function makeQR(myId) {
    const phoneUrl = baseUrl() + "?id=" + encodeURIComponent(myId);
    const qrEl = document.getElementById("qrcode");
    qrEl.innerHTML = "";
    new QRCode(qrEl, { text: phoneUrl, width:256, height:256 });
  }

  peer.on("open", (myId) => {
    statusEl.textContent = "Telefonla QR okutun. (Ä°nternet yoksa PIN ile aÃ§Ä±n)";
    debugEl.textContent = "Tahta Peer ID: " + myId;
    makeQR(myId);
    newQrBtn.onclick = () => location.reload();
  });

  peer.on("connection", (c) => {
    conn = c;
    statusEl.innerHTML = "<span class='ok'>Telefon baÄŸlandÄ± âœ…</span> Telefonda ONAYLA bekleniyorâ€¦";
    conn.on("data", (msg) => { if (msg === "UNLOCK") goTarget("QR"); });
    conn.on("close", () => statusEl.innerHTML = "<span class='bad'>BaÄŸlantÄ± koptu âŒ</span> PIN ile aÃ§abilirsiniz.");
  });

  peer.on("error", (err) => {
    statusEl.innerHTML = "<span class='bad'>QR baÄŸlantÄ±sÄ± yok âŒ</span> PIN ile aÃ§abilirsiniz.";
    debugEl.textContent = "Hata: " + (err?.type || "") + " - " + (err?.message || err);
  });

})();
</script>
</body>
</html>
